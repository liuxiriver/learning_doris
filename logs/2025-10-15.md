# 2025-10-15

## ä»Šæ—¥ç›®æ ‡
- æ•´ç†ä¸­æ–‡è‡ªå­¦ç›®å½•ä¸ä»»åŠ¡æ¸…å•ã€‚
- æ ¡å¯¹æœ¬åœ°æ„å»º/å¯åŠ¨å‘½ä»¤ä¸éªŒè¯è·¯å¾„ã€‚

## æ“ä½œè®°å½•
- æ–°å»º learning_doris ç›®å½•ä¸ä¸­æ–‡æ–‡æ¡£ã€‚
- æ¢³ç† FE/BE é˜…è¯»ä¸è°ƒè¯•åˆ‡å…¥å£ã€‚

## å…³é”®ç»“è®º
- å­¦ä¹ ä¸»çº¿æŒ‰ï¼šå¯åŠ¨ -> FE -> BE -> å­˜å‚¨ -> æµ‹è¯•/ç»ƒæ‰‹ã€‚
- ä»¥ä¸€æ¡ SQL ç«¯åˆ°ç«¯ä¸ºç‰µå¼•è¿›è¡Œæ–­ç‚¹éªŒè¯ã€‚

## æ˜æ—¥è®¡åˆ’
- å¯åŠ¨ FE/BE å¹¶æ‰§è¡Œæœ€å° SQLï¼Œè®°å½• EXPLAINã€‚
- åœ¨ FE çš„ Nereids è§„åˆ™ä¸ planner å¤„ä¸‹æ–­ç‚¹ã€‚

## è®¡åˆ’ä¸è®°å½• - M1 å¯åŠ¨ä¸éªŒè¯

### ç¯å¢ƒä¸ç‰ˆæœ¬
å‘½ä»¤ï¼š
uname -a
java -version
gcc --version
cmake --version
ç»“æœç²˜è´´ï¼š
Darwin Mac.lan 25.0.0 Darwin Kernel Version 25.0.0: Wed Sep 17 21:38:50 PDT 2025; root:xnu-12377.1.9~141/RELEASE_ARM64_T6031 arm64
openjdk version "11.0.26" 2025-01-21
OpenJDK Runtime Environment Homebrew (build 11.0.26+0)
OpenJDK 64-Bit Server VM Homebrew (build 11.0.26+0, mixed mode)
Apple clang version 17.0.0 (clang-1700.3.19.1)
Target: arm64-apple-darwin25.0.0
Thread model: posix
InstalledDir: /Library/Developer/CommandLineTools/usr/bin
cmake version 3.31.3

### Docker å¯åŠ¨ä¸éªŒè¯ï¼ˆä½¿ç”¨ local_env è„šæœ¬ï¼‰
å‘½ä»¤ï¼š
./learning_doris/local_env/start-doris.sh
ç»“æœç²˜è´´ï¼š
Doris cluster started successfully, version: 3.1.1
You can manage the cluster using the following commands:
  Stop cluster: docker-compose -f docker-compose-doris.yaml down
  View logs: docker-compose -f docker-compose-doris.yaml logs -f
  Connect to cluster: mysql -uroot -P9030 -h127.0.0.1
Persistent data directory: ./learning_doris/local_env/doris-data
  FE meta: ./learning_doris/local_env/doris-data/fe/doris-meta -> /opt/apache-doris/fe/doris-meta
  BE storage: ./learning_doris/local_env/doris-data/be/storage -> /opt/apache-doris/be/storage

Access FE/BE http ports (8030, 8040) using the following addresses (Mac system):
  http://docker.for.mac.localhost:8030
  http://docker.for.mac.localhost:8040
Note: If access fails, try using 127.0.0.1 address:
  http://127.0.0.1:8030
  http://127.0.0.1:8040
FE Web UI éªŒè¯ï¼šå·²æˆåŠŸæ‰“å¼€ `http://127.0.0.1:8030`ã€‚

---
--- 
å‘½ä»¤ï¼š
./learning_doris/local_env/manage-doris.sh status
ç»“æœç²˜è´´ï¼š
ğŸ“Š Doris cluster status:
WARN[0000] /Users/liuxi/Projects/liuxi/doris/docker-compose-doris.yaml: the attribute `version` is obsolete, it will be ignored, please remove it to avoid potential confusion 
NAME         IMAGE                   COMMAND                 SERVICE   CREATED              STATUS              PORTS
doris-be-1   apache/doris:be-3.1.1   "bash entry_point.sh"   be        About a minute ago   Up About a minute   0.0.0.0:8040->8040/tcp, :::8040->8040/tcp, 0.0.0.0:9050->9050/tcp, :::9050->9050/tcp
doris-fe-1   apache/doris:fe-3.1.1   "bash init_fe.sh"       fe        About a minute ago   Up About a minute   0.0.0.0:8030->8030/tcp, :::8030->8030/tcp, 0.0.0.0:9010->9010/tcp, :::9010->9010/tcp, 0.0.0.0:9030->9030/tcp, :::9030->9030/tcp

å¤‡æ³¨ï¼šä¸Šè¿° `version` è­¦å‘Šä¸º Docker æç¤ºï¼›compose æ–‡ä»¶æœªè®¾ç½® `version`ï¼Œå¯å¿½ç•¥ã€‚

Container details:
---
--- 
å‘½ä»¤ï¼š
./learning_doris/local_env/doris-sql.sh "SHOW FRONTENDS;"
ç»“æœç²˜è´´ï¼š
---
--- 
å‘½ä»¤ï¼š
./learning_doris/local_env/doris-sql.sh "SHOW BACKENDS\\G"
ç»“æœç²˜è´´ï¼š
liuxi@Mac:~/Projects/liuxi/doris% ./learning_doris/local_env/doris-sql.sh "SHOW FRONTENDS;"
WARN[0000] /Users/liuxi/Projects/liuxi/doris/docker-compose-doris.yaml: the attribute `version` is obsolete, it will be ignored, please remove it to avoid potential confusion 
Name    Host    EditLogPort     HttpPort        QueryPort       RpcPort ArrowFlightSqlPort      Role       IsMaster        ClusterId       Join    Alive   ReplayedJournalId       LastStartTime   LastHeartbeat      IsHelper        ErrMsg  Version CurrentConnected
fe_949163cc_5260_4f6d_b655_127b7705a16f 172.20.80.2     9010    8030    9030    9020    -1      FOLLOWER   true    773416400       true    true    293     2025-10-15 06:40:46     2025-10-15 06:42:46true            doris-3.1.1-rc01-fefeaf0dc7a    Yes
---
--- 
å‘½ä»¤ï¼š
./learning_doris/local_env/doris-sql.sh "SHOW BACKENDS\\G"
ç»“æœç²˜è´´ï¼š
*************************** 1. row ***************************
              BackendId: 1760404989588
                   Host: 172.20.80.3
          HeartbeatPort: 9050
                 BePort: 9060
               HttpPort: 8040
               BrpcPort: 8060
     ArrowFlightSqlPort: -1
          LastStartTime: 2025-10-15 06:40:45
          LastHeartbeat: 2025-10-15 06:43:46
                  Alive: true
   SystemDecommissioned: false
              TabletNum: 24
       DataUsedCapacity: 0.000 
      TrashUsedCapacity: 0.000 
          AvailCapacity: 137.113 GB
          TotalCapacity: 926.352 GB
                UsedPct: 85.20 %
         MaxDiskUsedPct: 85.20 %
     RemoteUsedCapacity: 0.000 
                    Tag: {"location" : "default"}
                 ErrMsg: 
                Version: doris-3.1.1-rc01-fefeaf0dc7a
                 Status: {"lastSuccessReportTabletsTime":"2025-10-15 06:42:54","lastStreamLoadTime":-1,"isQueryDisabled":false,"isLoadDisabled":false,"isActive":true,"currentFragmentNum":0,"lastFragmentUpdateTime":1760510573129}
HeartbeatFailureCounter: 0
               NodeRole: mix
               CpuCores: 14
                 Memory: 15.66 GB
---
--- 



### æœ€å° SQL ä¸ EXPLAIN
å‘½ä»¤ï¼š
./learning_doris/local_env/doris-sql.sh -f learning_doris/scripts/prepare_demo.sql
./learning_doris/local_env/doris-sql.sh -d demo "EXPLAIN SELECT * FROM t;"

ç»“æœç²˜è´´ï¼š

k1      v1
1       a
2       b
Explain String(Nereids Planner)
PLAN FRAGMENT 0
  OUTPUT EXPRS:
    k1[#0]
    v1[#1]
  PARTITION: UNPARTITIONED

  HAS_COLO_PLAN_NODE: false

  VRESULT SINK
     MYSQL_PROTOCAL

  1:VEXCHANGE
     offset: 0
     distribute expr lists: k1[#0]

PLAN FRAGMENT 1

  PARTITION: HASH_PARTITIONED: k1[#0]

  HAS_COLO_PLAN_NODE: false

  STREAM DATA SINK
    EXCHANGE ID: 01
    UNPARTITIONED

  0:VOlapScanNode(54)
     TABLE: demo.t(t), PREAGGREGATION: ON
     partitions=1/1 (t)
     tablets=1/1, tabletList=1760511281955
     cardinality=1, avgRowSize=0.0, numNodes=1
     pushAggOp=NONE



========== STATISTICS ==========



### æ¸…ç†/åœæ­¢
å‘½ä»¤ï¼š
```bash
./learning_doris/local_env/stop-doris.sh
```
æˆ–ï¼š
```bash
docker compose -f learning_doris/local_env/docker-compose-doris.yaml down
```

### å¿«é€ŸéªŒè¯ä¸ Profileï¼ˆæ¯æ¬¡ä¾‹è¡Œï¼‰
å‘½ä»¤ï¼š
```bash
./learning_doris/local_env/doris-sql.sh -d demo "SET enable_profile=true; SET profile_level=2; EXPLAIN SELECT * FROM t;"
./learning_doris/local_env/doris-sql.sh -d demo "SELECT count(*) FROM t WHERE k1 > 0;"
./learning_doris/local_env/doris-sql.sh -d demo "CREATE TABLE IF NOT EXISTS t2 AS SELECT k1, v1 FROM t; SELECT * FROM t JOIN t2 USING(k1);"
./learning_doris/local_env/doris-sql.sh -d demo "EXPLAIN SELECT k1, count(*) FROM t GROUP BY k1;"
```
è¯´æ˜ï¼šFE Web UI æ‰“å¼€åï¼Œå·¦ä¾§å¯¼èˆªè¿›å…¥ Query -> Query Profileï¼ˆæˆ– Queries/History é¡µå³ä¾§çš„ Profile é“¾æ¥ï¼‰ï¼Œç‚¹å‡»æœ€è¿‘ä¸€æ¬¡æŸ¥è¯¢çš„ QueryId æŸ¥çœ‹ Runtime Profile è¯¦æƒ…ã€‚

  ./learning_doris/local_env/doris-sql.sh -d demo -f learning_doris/scripts/bench.sql
